{% extends "index.html" %}

{% block title %}Analysis Results{% endblock title %}

{% block content %}
    {{ super() }}
    
    <h2>Analysis Results (Run ID: {{ run_id }})</h2>
    
    {% if metrics %}
        <h3>Metrics (Model: {{ metrics.best_model if is_prediction else "Correlation" }})</h3>
        
        <table border="1" cellpadding="10" style="width: 100%; max-width: 600px; border-collapse: collapse;">
            <tr>
                <th style="text-align: left; padding: 8px;">Metric</th>
                <th style="text-align: left; padding: 8px;">Value</th>
            </tr>
            
            {% if is_prediction %}
            <tr>
                <td>RÂ² (Coefficient of Determination)</td>
                <td>{{ metrics.get('r2') | round(4) if metrics.get('r2') is not none else 'N/A' }}</td>
            </tr>
            <tr>
                <td>RMSE (Root Mean Squared Error)</td>
                <td>{{ metrics.get('rmse') | round(4) if metrics.get('rmse') is not none else 'N/A' }}</td>
            </tr>
            <tr>
                <td>MAE (Mean Absolute Error)</td>
                <td>{{ metrics.get('mae') | round(4) if metrics.get('mae') is not none else 'N/A' }}</td>
            </tr>
            <tr>
                <td>Total Samples Used (N)</td>
                <td>{{ metrics.n_samples | int if metrics.n_samples is not none else 'N/A' }}</td>
            </tr>
            
            {% else %}
            <tr>
                <td>Pearson Correlation ($r$)</td>
                <td>{{ metrics.get('pearson_r') | round(4) if metrics.get('pearson_r') is not none else 'N/A' }}</td>
            </tr>
            <tr>
                <td>Spearman Correlation ($\rho$)</td>
                <td>{{ metrics.get('spearman_r') | round(4) if metrics.get('spearman_r') is not none else 'N/A' }}</td>
            </tr>
            <tr>
                <td>Total Overlapping Pixels (N)</td>
                <td>{{ metrics.get('n_pixels', metrics.get('n')) | int if metrics.get('n_pixels', metrics.get('n')) is not none else 'N/A' }}</td>
            </tr>
            
            {% endif %}
        </table>
        
        <h3 style="margin-top: 30px;">Visual Diagnostics</h3>

        {% if is_prediction %}
            <h4>Prediction Model Diagnostics</h4>
            <!-- Flexbox container for a responsive grid of plots -->
            <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                
                <div style="flex: 1; min-width: 450px;">
                    <h5>Parity Plot (Observed vs. Predicted)</h5>
                    <iframe src="{{ plotly_parity_url }}" frameborder="0" scrolling="no" style="width: 750px; height: 750px; border: none;"></iframe>
                </div>
                
                <div style="flex: 1; min-width: 800px;">
                    <h5>Residuals Histogram</h5>
                    <iframe src="{{ plotly_residuals_url }}" frameborder="0" scrolling="no" style="width: 100%; height: 750px; border: none;"></iframe>
                </div>
                
                {% if is_prediction and is_tree_model %}
                <div style="flex: 1; min-width: 450px;">
                    <h5>Feature Importance</h5>
                    <img src="{{ importance_url }}" alt="Feature Importance Plot" style="width: 100%; max-width: 500px; height: auto; border: 1px solid #ddd;">
                </div>
                {% endif %}

                <div style="flex: 1; min-width: 450px;">
                    <h5>Predictor Correlation Heatmap</h5>
                    <img src="{{ heatmap_url }}" alt="Predictor Correlation Heatmap" style="width: 800px; max-width: 800px; height: auto; border: 0.5px solid #ddd;">
                </div>

            </div>
            
        {% else %}
            <!-- This block is for the 'compare' results page -->
            <div style="display: flex; gap: 20px; flex-wrap: wrap;">

                <div style="flex: 1; min-width: 600px;">
                    <h4>Correlation Scatter Plot (Interactive)</h4>
                     <iframe src="{{ plotly_scatter_url }}" frameborder="0" scrolling="no" style="width: 100%; height: 800px; border: none;"></iframe>
                </div>

                <div style="flex: 1; min-width: 450px;">
                    <h4>Layer Correlation Heatmap</h4>
                    <img src="{{ heatmap_url }}" alt="Layer Correlation Heatmap" style="width: 100%; max-width: 500px; height: auto; border: 1px solid #ddd;">
                </div>
                
            </div>
        {% endif %}

    {% else %}
        <p>Could not load metrics for this run.</p>
    {% endif %}

    <p style="margin-top: 20px;">
        <a href="{{ url_for('compare_page') }}">Run another comparison</a> | <a href="{{ url_for('predict_page') }}">Run a prediction</a>
    </p>
    
    <script>
        // HIDE THE LOADING OVERLAY IMMEDIATELY ONCE THE CONTENT IS RENDERED
        document.addEventListener('DOMContentLoaded', function() {
            const globalOverlay = document.getElementById('loading-overlay');
            if (globalOverlay) {
                globalOverlay.style.display = 'none';
            }
        });
    </script>

{% endblock content %}

